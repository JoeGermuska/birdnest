<html>

<head>
    <title>Conference of the Birds — {{ playlist.date }}</title>
    {% include "_common_head.html" %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sortable/0.8.0/js/sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sortable/0.8.0/css/sortable-theme-bootstrap.css" />
</head>

<body>
    {% include "_nav.html" %}
    <section class="playlist">
        <h1>Conference of the Birds — {{ playlist.date }}</h1>
        <img class='playlist-image' src="{{ playlist.image_url }}">
        <p><a href="{{playlist.spotify_url}}">listen on spotify</a></p>
        <table class="sortable-theme-bootstrap" data-sortable>
            <thead>
                <tr>
                    <th></th>
                    <th></th>
                    <th>Artist</th>
                    <th>Track</th>
                    <th>Popularity</th>
                    <th>Valence</th>
                    <th>Danceability</th>
                    <th>Energy</th>
                    <th>Acousticness</th>
                    <th>Instrumentalness </th>
                    <th>Liveness </th>
                    <th>Loudness </th>
                    <th>Speechiness</th>
                    <th>Key </th>
                    <th>Tempo </th>
                    <th>Time Signature </th>
                </tr>
            </thead>
            <tbody>
                {% for track in playlist.tracks %}
                <tr class='playlist-row'>
                    <td>
                        {% if track.preview_url %}
                        <a class='preview-track' title='Play a preview clip' data-audio-id="audio-{{track.spotify_id}}"><i class="fas fa-play-circle" ></i></a>
                        <audio class='preview' id='audio-{{track.spotify_id}}' src="{{track.preview_url}}"></audio> {% endif %}
                    </td>
                    <td><a class='spotify-link' title='View Track on Spotify' href="{{ track.spotify_url}}" target='_blank'><i class="fab fa-spotify"></i></a></td>
                    <td>{% for artist in track.artists%}{% if not loop.first %}, {% endif %}<a href="{{ artist.spotify_url}}">{{ artist.name }}</a>{% endfor %}</td>
                    <td><a href="{{ track.spotify_url}}">{{ track.name }}</a></td>
                    <td>{{track.popularity}}</td>
                    <td>{{track.features.valence}}</td>
                    <td>{{track.features.danceability}}</td>
                    <td>{{track.features.energy}}</td>
                    <td>{{track.features.acousticness}}</td>
                    <td>{{track.features.instrumentalness }}</td>
                    <td>{{track.features.liveness }}</td>
                    <td>{{track.features.loudness }}</td>
                    <td>{{track.features.speechiness}}</td>
                    <td>{{track.features.key_str }} {{track.features.mode_str }}</td>
                    <td>{{track.features.tempo }}</td>
                    <td>{{track.features.time_signature }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </section>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.preview-track').forEach(
                (elem) => {
                    elem.addEventListener('click', (evt) => {
                        document.querySelectorAll('audio.preview').forEach(e => e.pause())
                        let to_play = document.getElementById(evt.currentTarget.dataset['audioId'])
                        if (to_play) {
                            if (to_play.paused) {
                                to_play.play()
                            } else {
                                // TODO: doesn't actually pause. Also the control appearance should change
                                to_play.pause()
                            }
                        }
                    })
                }
            )
        })
    </script>
</body>

</html>